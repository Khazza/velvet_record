<?php
session_start();
include('db.php');

// Vérifie si l'utilisateur est connecté
if (!isset($_SESSION['username'])) {
    header('Location: login.php');
    exit();
}

// Requête SQL pour compter le nombre de disques
$count_sql = "SELECT COUNT(*) as count FROM disc";
$count_stmt = $pdo->query($count_sql);
$count_row = $count_stmt->fetch(PDO::FETCH_ASSOC);
$count = $count_row['count'];
?>
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Liste des disques</title>
    <!-- Inclusion de Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <!-- Inclusion du fichier CSS personnalisé -->
    <link rel="stylesheet" href="./assets/css/styles.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand fs-1 fw-bold">
                Liste des disques (<span class="counter-style"><?php echo $count; ?></span>)
            </a>
            <div class="ml-auto">
                <a href="logout.php" class="btn btn-outline-primary me-2">Logout</a>
                <a href="add_disc.php" class="btn btn-primary">Ajouter un Disque</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card mb-3 border-0">
                    <div class="card-body">
                        <h5 class="card-title text-center" style="font-size: 18px;">Ajoutés récemment :</h5>
                        <div class="row d-flex justify-content-center">
                            <?php
                            // Requête SQL pour sélectionner les 5 derniers enregistrements de la table disc
                            $history_sql = "SELECT * 
                        FROM disc
                        JOIN artist ON disc.artist_id = artist.artist_id
                        ORDER BY disc_id DESC
                        LIMIT 5";
                            $history_stmt = $pdo->query($history_sql);

                            // Boucle pour afficher les enregistrements de l'historique
                            while ($history_row = $history_stmt->fetch(PDO::FETCH_ASSOC)) {
                            ?>
                                <div class="col-md-2 text-center">
                                    <img src="src/img/jaquettes/<?= $history_row['disc_picture']; ?>" class="card-img-top" alt="Jaquette" style="max-width: 50px;">
                                    <div class="mt-2">
                                        <span class="card-text" style="font-size: 14px;">
                                            <span class="fw-bold">Titre:</span><br>
                                            <?php echo $history_row['disc_title']; ?>
                                        </span><br>
                                        <span class="card-text" style="font-size: 14px;">
                                            <span class="fw-bold">Artiste:</span><br>
                                            <?php echo $history_row['artist_name']; ?>
                                        </span>
                                    </div>
                                </div>
                            <?php
                            }
                            ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <?php
            // Requête SQL pour sélectionner tous les disques avec les informations sur l'artiste correspondant
            $disc_sql = "SELECT *
FROM disc
JOIN artist ON disc.artist_id = artist.artist_id
ORDER BY disc_id ASC";
            $disc_stmt = $pdo->query($disc_sql);
            // Boucle pour afficher les enregistrements des disques
            while ($disc_row = $disc_stmt->fetch(PDO::FETCH_ASSOC)) {
            ?>
                <div class="col-md-4">
                    <div class="card mb-3">
                        <img src="src/img/jaquettes/<?= $disc_row['disc_picture']; ?>" class="card-img-top" alt="Jaquette">
                        <div class="card-body">
                            <h5 class="card-title"><?= $disc_row['disc_title']; ?></h5>
                            <p class="card-text"><span class="fw-bold">Artiste:</span> <?= $disc_row['artist_name']; ?></p>
                            <p class="card-text"><span class="fw-bold">Année:</span> <?= $disc_row['disc_year']; ?></p>
                            <p class="card-text"><span class="fw-bold">Genre:</span> <?= $disc_row['disc_genre']; ?></p>
                            <a href="update_disc.php?id=<?= $disc_row['disc_id']; ?>" class="btn btn-outline-secondary me-2">Modifier</a>
                            <a href="delete_disc.php?id=<?= $disc_row['disc_id']; ?>" class="btn btn-outline-danger">Supprimer</a>
                        </div>
                    </div>
                </div>
            <?php
            }
            ?>
        </div>
    </div>

    <!-- Inclusion de Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>